#####################################
#           INCLUDES                #
#####################################

[include mainsail.cfg]
[include H36.cfg]
[include leds.conf]
[include macros.cfg]
[include sfs.conf]
[include cartographer.cfg]
# [include adxl345.cfg]

#####################################
#           BASICS                  #
#####################################

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_m5p-if00
canbus_uuid: a71730cf9060

[mcu host]
serial: /tmp/klipper_host_mcu

[printer]
kinematics: corexz
max_velocity: 250
max_accel: 1500
max_z_velocity: 50
max_z_accel: 1000

[skew_correction]
[exclude_object]

#####################################
#           STEPPER                 #
#####################################

[stepper_x]
step_pin: PC8
dir_pin: PC9
enable_pin: !PA15
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: H36_combo:PA10
position_endstop: 300
position_max: 300
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PD9
run_current: 1.2
diag_pin: PD3
# stealthchop_threshold: 999999
interpolate: true

[autotune_tmc stepper_x]
motor: omc-17hs19-2004s1
tuning_goal: performance

[stepper_y]
step_pin: PA10
dir_pin: !PA14
enable_pin: !PA13
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: PD2
position_endstop: -15
position_max: 300
position_min: -15
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PD8
run_current: 1.2
diag_pin: PD2
# stealthchop_threshold: 999999
interpolate: true

[autotune_tmc stepper_y]
motor: omc-17hs19-2004s1
tuning_goal: performance

[stepper_z]
step_pin: PC6
dir_pin: PC7
enable_pin: !PA9
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
# endstop_pin: ^PC3
endstop_pin: probe:z_virtual_endstop # uses cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
# position_endstop: 0.0
position_max: 300
position_min: -2

[tmc2209 stepper_z]
uart_pin: PB10
run_current: 1.2
diag_pin: PC3
# stealthchop_threshold: 999999
interpolate: true

[autotune_tmc stepper_z]
motor: omc-17hs19-2004s1
tuning_goal: performance

#####################################
#           EXTRUDER                #
#####################################

[extruder]
step_pin: H36_combo:PB9 
dir_pin: !H36_combo:PB8
enable_pin: !H36_combo:PB7
rotation_distance: 51.75
gear_ratio: 11.25:1
max_extrude_only_distance: 200.0 # must be greater than the distance of the single segment above
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section: 5
heater_pin: H36_combo: PA7
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: H36_combo:PA6
pullup_resistor: 4700
control: pid
min_temp: 0
max_temp: 300
pressure_advance: 0.035
pid_Kp: 23.742
pid_Ki: 1.884
pid_Kd: 74.785

[tmc2209 extruder]
uart_pin: H36_combo:PC14
interpolate: false
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

[gcode_button nebula_unload_button]
pin: ^!H36_combo:PC7 # Gcode Button pin（marked as GB on extruder)
debounce_delay: 0.02
press_gcode:
release_gcode:
  {% if printer.print_stats.state != "printing" %}
    {% set fs = printer['gcode_button filament_sensor'] %}
    {% if fs.state == "RELEASED" %}
      NEBULA_UNLOAD_FILAMENT
    {% endif %}
  {% endif %}

[gcode_button filament_sensor]
pin: ^H36_combo:PA15 # Filament sensor pin（marked as FS on extruder)
debounce_delay: 0.5
press_gcode:
  {% if printer.print_stats.state == "printing" %}
    PAUSE # [pause_resume] is required in printer.cfg
  {% endif %}
release_gcode:
  {% if printer.print_stats.state != "printing" %}
    NEBULA_LOAD_FILAMENT
  {% endif %}

#####################################
#           TEMPERATURE             #
#####################################

[temperature_sensor Manta]
sensor_type              : temperature_mcu
sensor_mcu               : mcu

[temperature_sensor CM4]
sensor_type: temperature_host

[heater_bed]
heater_pin: PA5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0
min_temp: 0
max_temp: 150

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PA1
min_temp: 0
max_temp: 100

#####################################
#           Input Shaper            #
#####################################

[adxl345]
cs_pin: H36_combo:PB12
spi_software_sclk_pin: H36_combo:PB10
spi_software_mosi_pin: H36_combo:PB11
spi_software_miso_pin: H36_combo:PB2
axes_map: -y,z,-x

[resonance_tester]
accel_chip: adxl345
probe_points:
    300,300,30 # an example

#####################################
#               FANS                #
#####################################

[temperature_fan electronics_compartment]
pin: PA4
sensor_type: temperature_host
off_below: 0.4
min_temp: 10
max_temp: 90
target_temp: 40
control: pid
pid_Kp: 2
pid_Ki: 4
pid_Kd: 0.1

[controller_fan steppers]
pin: host:gpio26
fan_speed: 0.75
idle_timeout: 30
idle_speed: 0.2
stepper: stepper_x,stepper_y,stepper_z

[fan_generic nevermore]
pin: PA3

#####################################
#               OTHER               #
#####################################

[bed_screws]
screw1: 52,55
screw1_name: front left
screw2: 250,55
screw2_name: front right
screw3: 250,255
screw3_name: back right
screw4: 52,255
screw4_name: back left
speed: 100.0

[screws_tilt_adjust]
screw1: 52,33.58
screw1_name: front left
screw2: 250,33.58
screw2_name: front right
screw3: 250,233.58
screw3_name: back right
screw4: 52,233.58
screw4_name: back left
speed: 200
horizontal_move_z: 3
screw_thread: CW-M5

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PD5, EXP1_3=PB3, EXP1_5=PB5, EXP1_7=PB7, EXP1_9=<GND>,
    EXP1_2=PD4,  EXP1_4=PD6, EXP1_6=PB4, EXP1_8=PB6, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PB14, EXP2_3=PB8, EXP2_5=PC10, EXP2_7=PC12,  EXP2_9=<GND>,
    EXP2_2=PB13, EXP2_4=PB9, EXP2_6=PB15, EXP2_8=<RST>, EXP2_10=<NC>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.937
#*# pid_ki = 0.806
#*# pid_kd = 1005.649
#*#
#*# [bed_mesh adaptive]
#*# version = 1
#*# points =
#*# 	0.338172, 0.257543, 0.214439, 0.173837, 0.163151, 0.168149, 0.199276, 0.251844
#*# 	0.219745, 0.163151, 0.129689, 0.099879, 0.090946, 0.103152, 0.130589, 0.193886
#*# 	0.141200, 0.078424, 0.056753, 0.042345, 0.058179, 0.083870, 0.114810, 0.170438
#*# 	0.085276, 0.040414, 0.015441, 0.004665, 0.010781, 0.049561, 0.099879, 0.172254
#*# 	0.052914, -0.002203, -0.010838, -0.016781, 0.000501, 0.047636, 0.105940, 0.177700
#*# 	0.071061, 0.029783, 0.020799, 0.012506, 0.024199, 0.062497, 0.116675, 0.190286
#*# 	0.105244, 0.056753, 0.054834, 0.050053, 0.080565, 0.115290, 0.149452, 0.218000
#*# 	0.122263, 0.096816, 0.099396, 0.085276, 0.098455, 0.139118, 0.175417, 0.261868
#*# x_count = 8
#*# y_count = 8
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 259.96000000000004
#*# min_y = 20.0
#*# max_y = 259.96000000000004
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 41.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 23.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	1.183632, 1.054791, 0.927400, 0.787553, 0.651456, 0.526328, 0.388698, 0.258543, 0.144156, 0.023236, -0.105423, -0.224121, -0.325525, -0.460208, -0.599356, -0.712073, -0.812956, -0.946089, -1.047341, -1.132982
#*# 	1.202801, 1.076910, 0.942248, 0.804780, 0.671846, 0.544790, 0.409807, 0.285235, 0.160567, 0.039734, -0.093679, -0.211246, -0.313836, -0.432132, -0.605769, -0.702177, -0.794603, -0.946529, -1.056406, -1.117592
#*# 	1.214556, 1.080497, 0.948820, 0.812425, 0.676691, 0.552592, 0.415706, 0.281844, 0.163577, 0.049380, -0.078596, -0.214234, -0.307552, -0.445861, -0.587468, -0.688076, -0.804981, -0.942103, -1.033666, -1.124924
#*# 	1.236238, 1.107399, 0.968733, 0.829924, 0.694966, 0.563169, 0.439039, 0.301537, 0.193708, 0.057572, -0.063737, -0.175395, -0.299666, -0.428104, -0.552846, -0.678772, -0.794738, -0.911309, -1.037293, -1.102601
#*# 	1.273690, 1.143241, 1.012447, 0.871653, 0.732614, 0.608592, 0.477694, 0.338521, 0.219148, 0.100757, -0.036544, -0.148017, -0.257763, -0.415780, -0.524595, -0.643707, -0.769386, -0.879626, -0.989989, -1.062487
#*# 	1.275440, 1.141847, 1.007813, 0.862792, 0.731503, 0.603081, 0.460186, 0.334622, 0.208320, 0.078876, -0.037361, -0.165037, -0.279506, -0.390043, -0.542803, -0.658585, -0.752058, -0.899353, -1.012559, -1.069911
#*# 	1.250747, 1.118594, 0.989479, 0.848796, 0.709564, 0.583057, 0.447358, 0.305689, 0.191084, 0.068093, -0.074645, -0.176381, -0.288715, -0.442453, -0.544396, -0.661735, -0.796601, -0.899939, -1.016067, -1.085701
#*# 	1.276110, 1.141133, 1.005109, 0.857872, 0.720266, 0.589247, 0.453833, 0.324972, 0.190601, 0.067635, -0.059887, -0.178789, -0.290838, -0.394659, -0.565014, -0.662498, -0.755700, -0.908047, -1.024575, -1.099089
#*# 	1.283264, 1.150001, 1.016096, 0.871404, 0.728495, 0.601604, 0.464663, 0.322042, 0.205430, 0.080762, -0.062797, -0.184304, -0.276387, -0.433229, -0.551676, -0.650415, -0.781613, -0.905261, -1.008444, -1.096453
#*# 	1.280559, 1.143786, 1.010122, 0.867059, 0.724420, 0.596666, 0.466629, 0.315470, 0.184647, 0.072702, -0.070962, -0.190208, -0.286924, -0.425767, -0.562549, -0.660388, -0.781317, -0.917349, -1.020312, -1.107231
#*# 	1.283903, 1.149445, 1.015169, 0.869373, 0.729679, 0.600557, 0.461462, 0.313870, 0.188813, 0.065815, -0.073011, -0.202510, -0.296243, -0.433074, -0.570711, -0.670801, -0.793297, -0.932165, -1.027657, -1.115591
#*# 	1.291442, 1.153596, 1.018295, 0.868548, 0.724848, 0.598693, 0.460408, 0.314967, 0.188818, 0.059368, -0.082714, -0.211804, -0.288173, -0.441955, -0.591152, -0.661197, -0.801464, -0.940363, -1.018706, -1.137412
#*# 	1.309127, 1.172599, 1.033212, 0.882029, 0.736295, 0.602242, 0.473068, 0.320624, 0.189204, 0.061186, -0.061722, -0.190251, -0.310855, -0.416342, -0.573164, -0.685786, -0.778386, -0.935922, -1.049285, -1.107347
#*# 	1.359169, 1.217909, 1.077143, 0.926480, 0.777272, 0.640039, 0.503614, 0.361198, 0.224794, 0.105458, -0.025954, -0.159727, -0.263832, -0.387165, -0.529754, -0.659731, -0.757814, -0.916177, -1.022834, -1.078231
#*# 	1.360743, 1.221640, 1.085067, 0.931911, 0.783752, 0.649041, 0.506825, 0.359656, 0.236166, 0.103096, -0.030640, -0.151406, -0.259625, -0.403020, -0.544760, -0.648498, -0.768010, -0.885883, -0.999910, -1.068764
#*# 	1.355503, 1.214829, 1.074514, 0.922867, 0.779786, 0.640187, 0.491168, 0.353344, 0.223035, 0.086732, -0.046031, -0.167725, -0.274956, -0.419642, -0.558570, -0.662660, -0.781863, -0.919295, -1.013587, -1.118518
#*# 	1.362355, 1.225153, 1.083032, 0.935192, 0.789063, 0.650151, 0.507864, 0.360929, 0.235139, 0.093542, -0.047749, -0.152071, -0.269844, -0.412075, -0.557078, -0.659445, -0.780195, -0.913866, -1.002742, -1.099225
#*# 	1.368002, 1.226631, 1.087445, 0.938515, 0.789781, 0.656537, 0.509235, 0.362336, 0.230359, 0.103556, -0.049566, -0.150345, -0.267651, -0.413308, -0.569558, -0.646561, -0.777340, -0.929711, -1.007016, -1.080807
#*# 	1.362078, 1.225320, 1.086693, 0.938820, 0.791050, 0.657042, 0.505649, 0.354340, 0.233585, 0.098831, -0.050347, -0.170601, -0.279228, -0.397705, -0.555837, -0.673456, -0.792991, -0.890673, -1.006544, -1.090281
#*# 	1.360907, 1.231430, 1.092988, 0.946914, 0.797292, 0.662231, 0.510017, 0.364386, 0.238003, 0.105835, -0.039465, -0.160065, -0.265243, -0.431505, -0.555249, -0.646382, -0.779004, -0.916290, -1.024000, -1.089997
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 40.0
#*# max_x = 260.0
#*# min_y = 25.0
#*# max_y = 275.0
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.004614331636512251
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2000
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.546678096519472,
#*# 	1.8946854357655871,
#*# 	0.7240337891386859,
#*# 	0.06261043362612324,
#*# 	0.44527684179085186,
#*# 	1.354510796801985,
#*# 	-0.426351661414687,
#*# 	-1.748612327778517,
#*# 	0.3606593986887026,
#*# 	0.889191777796337
#*# model_domain = 3.2205378239610475e-07,3.3173012074846614e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 24.559745
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.520586038806431,2.012101598960563,0.8129751712888509,0.1839048008832576,0.47429784082405413,1.1633792366753806,-0.4296042500232768,-1.4703668678355273,0.4220632430313439,0.8132808508228747
#*# domain = 3.229766618243892e-07,3.323030625124981e-07
#*# z_offset = 0
#*# reference_temperature = 48.82
#*#
#*# [cartographer touch_model default]
#*# threshold = 1054
#*# speed = 2
#*# z_offset = -0.05
